# 单元测试重构详细实施计划

*基于《单元测试框架重构方案.md》的具体执行步骤*

---

## 🎯 总体目标

将测试通过率从 **65%** 提升到 **90%+**，修复覆盖率统计问题，建立可信赖的测试基准。

---

## 📋 Phase 1: 环境配置修复 (P0 - 紧急)

### 🔧 P0-1: 修复定时器API缺失

**目标**: 解决 `ReferenceError: clearInterval is not defined` 错误

**具体步骤**:

1. **分析当前setup.ts**
   ```bash
   # 检查当前配置
   cat utest/setup.ts | grep -E "(setInterval|clearInterval|setImmediate)"
   ```

2. **修改 utest/setup.ts**
   ```typescript
   // 添加到文件中
   global.setInterval = vi.fn((callback: Function, delay: number) => {
     // 对于测试环境，可以控制执行
     if (delay === 1000) { // 内存监控定时器
       setTimeout(callback, 0); // 立即执行一次
     }
     return 123 as any; // 返回模拟ID
   });

   global.clearInterval = vi.fn((id: any) => {
     // 清理定时器的模拟实现
     if (typeof id === 'number') {
       clearTimeout(id);
     }
   });

   global.setImmediate = vi.fn((callback: Function) => {
     return setTimeout(callback, 0);
   });

   global.clearImmediate = vi.fn((id: any) => {
     clearTimeout(id);
   });
   ```

3. **验证修复效果**
   ```bash
   # 运行MemoryManager测试验证
   npx vitest run shared/MemoryManager-Real.test.ts --config vitest.config.mjs
   ```

**成功标准**: MemoryManager 测试通过率从 66.7% 提升到 85%+

---

### 🔧 P0-2: 修复Vue环境问题

**目标**: 解决 `nextTick is not a function` 错误

**具体步骤**:

1. **检查Vue相关测试失败**
   ```bash
   # 查找Vue组件测试
   find utest -name "*.test.ts" -exec grep -l "nextTick\|vue" {} \;
   ```

2. **修改 utest/setup.ts**
   ```typescript
   // 添加Vue环境支持
   import { nextTick } from 'vue';
   
   // 确保nextTick可用
   global.nextTick = nextTick;
   
   // 添加Vue测试工具支持
   import { config } from '@vue/test-utils';
   config.global.mocks = {
     $t: (key: string) => key, // i18n mock
   };
   ```

3. **验证修复效果**
   ```bash
   # 运行Vue相关测试
   npx vitest run webview/ --config vitest.config.mjs
   ```

**成功标准**: Vue组件测试通过率从 45% 提升到 70%+

---

### 🔧 P0-3: 修复Node.js API缺失

**目标**: 添加性能监控和其他Node.js API支持

**具体步骤**:

1. **添加性能监控API**
   ```typescript
   // 在 utest/setup.ts 中添加
   if (typeof performance === 'undefined') {
     global.performance = {
       now: () => Date.now(),
       mark: vi.fn(),
       measure: vi.fn(),
       getEntries: vi.fn(() => []),
       getEntriesByName: vi.fn(() => []),
       getEntriesByType: vi.fn(() => [])
     } as any;
   }

   // 添加PerformanceObserver mock
   global.PerformanceObserver = class PerformanceObserver {
     constructor(callback: Function) {}
     observe() {}
     disconnect() {}
     takeRecords() { return []; }
   } as any;
   ```

2. **添加其他缺失的API**
   ```typescript
   // 文件系统API mock (用于导出模块测试)
   if (typeof FileReader === 'undefined') {
     global.FileReader = class FileReader {
       readAsText() {}
       readAsDataURL() {}
       result: string | null = null;
       onload: Function | null = null;
       onerror: Function | null = null;
     } as any;
   }
   ```

**验证方法**:
```bash
# 运行性能相关测试
npx vitest run performance/ --config vitest.config.mjs
```

**成功标准**: 性能模块测试通过率提升到 80%+

---

## 📊 Phase 2: 覆盖率工具修复 (P1 - 重要)

### 🔍 P1-1: 分析覆盖率路径映射问题

**目标**: 理解为什么V8显示0%覆盖率

**具体步骤**:

1. **详细检查当前配置**
   ```bash
   # 检查vitest配置
   cat utest/vitest.config.mjs | grep -A 20 "coverage:"
   ```

2. **测试不同路径配置**
   ```javascript
   // 在 vitest.config.mjs 中尝试
   coverage: {
     provider: 'v8',
     reportsDirectory: './coverage',
     include: [
       '../src/**/*.ts',           // 尝试相对路径
       path.resolve(__dirname, '../src/**/*.ts'), // 尝试绝对路径
     ],
     all: true,  // 包含所有文件
   }
   ```

3. **单模块验证**
   ```bash
   # 测试单个模块的覆盖率
   npx vitest run parsing/DataDecoder-Real.test.ts --coverage --config vitest.config.mjs
   ```

**成功标准**: 能够显示 >0% 的覆盖率数据

---

### 🔍 P1-2: 尝试不同覆盖率提供器

**目标**: 找到最适合的覆盖率工具

**具体步骤**:

1. **测试c8提供器**
   ```bash
   # 安装c8
   npm install --save-dev c8
   
   # 修改配置尝试c8
   # coverage: { provider: 'c8' }
   ```

2. **测试istanbul提供器**
   ```bash
   # 安装istanbul相关包
   npm install --save-dev @vitest/coverage-istanbul
   
   # 修改配置
   # coverage: { provider: 'istanbul' }
   ```

3. **对比测试结果**
   ```bash
   # 分别运行并对比结果
   npx vitest run parsing/DataDecoder-Real.test.ts --coverage
   ```

**成功标准**: 选择能正确显示覆盖率的provider

---

### 🔍 P1-3: 建立覆盖率基准

**目标**: 获取可信的覆盖率数据

**具体步骤**:

1. **运行全量测试获取基准**
   ```bash
   # 运行所有Real测试获取准确数据
   npx vitest run "**/\*-Real.test.ts" --coverage
   ```

2. **生成详细报告**
   ```bash
   # 生成HTML报告查看详情
   npx vitest run --coverage --reporter=html
   ```

3. **建立模块级别基准**
   ```bash
   # 分模块统计
   for module in parsing shared extension webview; do
     npx vitest run ${module}/*-Real.test.ts --coverage
   done
   ```

**成功标准**: 获得各模块真实覆盖率数据

---

## 🧹 Phase 3: 测试质量提升 (P2 - 优化)

### 🎯 P2-1: 清理无效测试

**目标**: 提升测试质量，移除无价值测试

**具体步骤**:

1. **识别测试文件类型**
   ```bash
   # 统计不同类型测试
   find utest -name "*-Real.test.ts" | wc -l
   find utest -name "*-Mock.test.ts" | wc -l  
   find utest -name "*-Coverage.test.ts" | wc -l
   ```

2. **评估Mock测试价值**
   ```bash
   # 检查Mock测试是否测试真实源码
   grep -r "from.*src/" utest/*-Mock.test.ts
   ```

3. **清理纯覆盖率测试**
   ```bash
   # 移动无价值的Coverage测试到archive目录
   mkdir -p utest/archive/coverage-boost
   find utest -name "*-Coverage*.test.ts" -exec mv {} utest/archive/coverage-boost/ \;
   ```

**成功标准**: 保留80%+有价值测试，移除无效测试

---

### 🎯 P2-2: 增强测试稳定性

**目标**: 提升测试运行的一致性

**具体步骤**:

1. **优化测试配置**
   ```javascript
   // vitest.config.mjs
   test: {
     retry: 2,           // 失败重试
     testTimeout: 15000, // 增加超时
     setupFiles: ['./setup.ts'],
     pool: 'forks',      // 隔离测试环境
     poolOptions: {
       forks: {
         singleFork: true, // 避免并发问题
       }
     }
   }
   ```

2. **添加测试前置检查**
   ```typescript
   // setup.ts 中添加
   beforeAll(() => {
     // 确保测试环境完整性
     console.log('🧪 Test environment setup completed');
   });
   ```

3. **验证稳定性**
   ```bash
   # 连续运行3次检查一致性
   for i in {1..3}; do
     echo "Run $i:"
     npx vitest run shared/MemoryManager-Real.test.ts
   done
   ```

**成功标准**: 连续3次运行结果一致

---

## ✅ 验证和交付

### 📊 最终验证清单

1. **环境修复验证**
   - [ ] MemoryManager测试通过率 > 90%
   - [ ] 无`clearInterval is not defined`错误
   - [ ] Vue组件测试稳定运行

2. **覆盖率修复验证**
   - [ ] 显示真实覆盖率数据 (>0%)
   - [ ] 生成有效的HTML报告
   - [ ] 各模块覆盖率数据合理

3. **质量提升验证**
   - [ ] 整体通过率 > 90%
   - [ ] 测试运行结果稳定一致
   - [ ] 测试文件清理完成

### 📋 交付成果

1. **修复后的配置文件**
   - `utest/setup.ts` - 完整的环境配置
   - `utest/vitest.config.mjs` - 优化的测试配置

2. **测试报告**
   - 各模块通过率和覆盖率数据
   - 问题修复前后对比
   - 测试稳定性验证报告

3. **文档更新**
   - 更新后的测试状态文档
   - 测试运行指南
   - 持续集成建议

---

## 🚀 开始执行

**下一步行动**:
1. 立即开始 P0-1：修复定时器API缺失
2. 验证 MemoryManager 测试改善
3. 依序执行后续步骤

**预计时间**: 总计 1-2 周完成全部修复

---

*每完成一个步骤都要验证效果，确保改善真实有效。*